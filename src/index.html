<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <script src="/webui.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        display: flex;
        flex-direction: column; /* 세로 방향으로 배치 */
        align-items: center; /* 중앙 정렬 */
        padding: 20px;
        font-family: Arial, sans-serif;
        height: 100vh; /* 전체 높이를 viewport 높이로 설정 */
      }

      #container {
        display: flex; /* 가로 방향으로 배치 */
        justify-content: space-between; /* 양쪽 끝에 배치 */
        width: 100%; /* 전체 너비 */
        margin-top: 20px; /* 버튼과의 여백 */
        flex-grow: 1; /* 남은 공간을 차지하도록 설정 */
      }
      #legendData {
        display: flex; /* 가로 방향으로 배치 */
      }
      #table {
        display: none;
        width: 30%; /* 표 영역의 너비 */
      }

      #chart {
        display: none;
        width: 60%; /* 그래프 영역의 너비 */
        max-height: calc(100vh - 100px); /* 차트 최대 높이 설정 */
      }

      canvas {
        width: 100%;
        height: 100%; /* 차트의 높이를 부모 요소의 높이에 맞춤 */
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin: auto;
      }

      table,
      th,
      td {
        border: 1px solid black;
      }

      th,
      td {
        padding: 6px;
        text-align: left;
      }

      th {
        background-color: #f2f2f2;
      }

      .section-header {
        font-weight: bold;
        text-align: center;
        background-color: #d9d9d9;
      }

      .dygraph-legend {
        position: absolute;
        top: 0; /* 위쪽에 표시 */
        left: 50px;
        z-index: 10;
        background-color: rgba(255, 255, 255, 0.7);
        overflow: hidden;
      }

      .legendData label {
        width: 100px; /* 라벨의 너비 */
        margin-right: 80px;
      }
    </style>
    <title>값 변경하기</title>
  </head>
  <body>
    <div class="section-header">drivercom-gui</div>
    <label for="avatar">config 파일을 선택해 주세요.</label>
    <input type="file" id="avatar" name="avatar" accept=" .json " />
    <script>
      function showConfig() {
        var input = document.getElementById("avatar");
        var file = input.files[0]; // 선택한 파일 객체
        if (file) {
          const promise = readJSONFile(file);
          promise.then((result) => {
            const dict = result;

            //모든 value 저장
            const all_value = extractValues(dict);

            //html의 모든 ids 저장
            const allElements = document.querySelectorAll(
              'input[type="text"], input[type="number"],  input[type="checkbox"]',
            );
            const ids = [];
            allElements.forEach((element) => {
              ids.push(element.id);
            });

            //값을 변환
            for (let i = 0; i < ids.length; i++) {
              var v = document.getElementById(ids[i]);
              v.value = all_value[i];
              if (v.id.includes("flags")) {
                v.checked = all_value[i];
              }
            }
          });
        }
        const myTable = document.getElementById("table");
        myTable.style.display = "table";
      }

      function readJSONFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = function (e) {
            const content = e.target.result;
            try {
              const json_object = JSON.parse(content); // object 형식으로
              resolve(json_object); // 파싱된 객체를 반환
            } catch (err) {
              reject("JSON 파싱 오류: " + err.message); // 오류 발생 시
            }
          };
          reader.onerror = function () {
            reject("파일 읽기 오류");
          };
          reader.readAsText(file); // 파일을 텍스트 형식으로 읽음
        });
      }

      function newValue() {
        //html의 모든 ids 저장
        const allElements = document.querySelectorAll(
          'input[type="text"], input[type="number"],  input[type="checkbox"]',
        );
        const ids = [];
        allElements.forEach((element) => {
          ids.push(element.id);
        });

        //값을 변환
        for (let i = 0; i < ids.length; i++) {
          var v = document.getElementById(ids[i]);
          v.value = 0;
          if (v.id.includes("flags")) {
            v.checked = false;
          }
        }
        const myTable = document.getElementById("table");
        myTable.style.display = "table";
      }

      function saveFile() {
        webui.call("sendJson").then((response) => {
          const dict = JSON.parse(response);
          //html의 모든 value 저장
          const allElements = document.querySelectorAll(
            'input[type="text"], input[type="number"], input[type="checkbox"]',
          );
          const values = []; //
          allElements.forEach((element) => {
            if (element.value == "") {
              values.push(0);
            } else if (element.id.includes("flags")) {
              values.push(element.checked);
            } else {
              values.push(element.value);
            }
          });
          extractKey(dict, values);

          //파일 저장
          const blob = new Blob([JSON.stringify(dict, null, "  ")], {
            type: "text/json",
          });
          const url = URL.createObjectURL(blob);
          // 다운로드 링크 생성
          const a = document.createElement("a");
          a.href = url;
          // 현재 날짜와 시간을 가져오기
          const currentDate = new Date();
          // 날짜와 시간을 문자열로 포맷팅
          const formattedDate = `${currentDate.getFullYear()}-${currentDate.getMonth() + 1}-${currentDate.getDate()} ${currentDate.getHours()}:${currentDate.getMinutes()}:${currentDate.getSeconds()}`;
          // 포맷팅된 날짜와 시간을 출력
          a.download = formattedDate + "config.json"; // 다운로드할 파일 이름
          // 링크 클릭하여 다운로드
          document.body.appendChild(a);
          a.click();
          // 링크 제거
          document.body.removeChild(a);
          URL.revokeObjectURL(url); // Blob URL 해제
        });
      }

      function extractKey(dict, values) {
        let index = 0;
        function traverseDict(obj) {
          for (let key in obj) {
            if (typeof obj[key] == "object") {
              traverseDict(obj[key]);
            } else {
              obj[key] = values[index];
              index++;
            }
          }
        }
        traverseDict(dict);
      }

      function extractValues(dict) {
        const result = [];
        for (const key in dict) {
          const value = dict[key];
          if (typeof value != "object") {
            result.push(value);
          } else {
            const in_value = extractValues(value);
            result.push(...in_value);
          }
        }
        return result;
      }

      document.getElementById("avatar").addEventListener("change", showConfig);
    </script>
    <button type="button" onclick="newValue();" , id="newBtn">new</button>
    <button type="button" onclick="saveFile();">save</button>
    <label for="avatar">.csv 파일을 선택해 주세요.</label>
    <input type="file" id="loadCsv" name="avatar" accept=" .csv " />
    <button type="button" id="resetZoomBtn">차트 리셋</button>

    <script>
      //csv파일 열기(file 사용)
      function showCsv() {
        var input = document.getElementById("loadCsv");
        var file = input.files[0]; // 선택한 파일 객체
        if (file) {
          const promise = readCsvFileTest(file);
          promise.then((result) => {
            showTestChart(result);
          });
        }
        const myTable = document.getElementById("table");
        myTable.style.display = "none";
      }
      //csv파일이 바뀔때 마다 함수를 실행
      document.getElementById("loadCsv").addEventListener("change", showCsv);

      //csv파일의 내용을 읽어와 배열과 딕셔너리 형태로 변환
      function readCsvFileTest(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = function (e) {
            const csvData = e.target.result;
            try {
              let rows = csvData.split("\n");

              //테스트
              let headers = rows[0].split(",").map((col) => col.trim());
              const bool_headers = [[], []];
              const num_headers = [[], []];
              const bool_datas = [];
              const num_datas = [];

              //자료형에 따른 헤더 분리
              rows[1].split(",").forEach((data, index) => {
                const d = data.trim().toLowerCase();
                if (d == "true" || d == "false") {
                  bool_headers[0].push(headers[index]);
                  bool_headers[1].push(index);
                } else {
                  num_headers[0].push(headers[index]);
                  num_headers[1].push(index);
                }
              });
              bool_datas.push(bool_headers[0]);
              num_datas.push(num_headers[0]);

              //자료형에 따른 데이터 분리(bool, number)
              rows.slice(1).forEach((row) => {
                const columns = row.split(",").map((col) => col.trim());
                const b_col = [];
                const n_col = [];

                bool_headers[1].forEach((index) => {
                  const boolValue = columns[index];
                  if (boolValue) {
                    var re_value = boolValue.replace(
                      /true/g,
                      `${b_col.length + 1}`,
                    );
                    re_value = re_value.replace(/false/g, "0");
                    b_col.push(re_value);
                  }
                });
                num_headers[1].forEach((index) => {
                  const numericRow = columns[index];
                  n_col.push(numericRow);
                });
                bool_datas.push(b_col.join(",")); //,로 연결된 문자열로 저장
                num_datas.push(n_col.join(","));
              });

              //열 번호 추가
              let bool_csv = ["num, " + bool_datas[0]];
              let num_csv = ["num, " + num_datas[0]];

              //데이터 추가
              bool_datas.slice(1).forEach((data, index) => {
                if (data.trim()) {
                  bool_csv.push(`${index + 1}, ${data}`);
                }
              });
              num_datas.slice(1).forEach((data, index) => {
                if (data.trim()) {
                  num_csv.push(`${index + 1}, ${data}`);
                }
              });

              bool_csv = bool_csv.join("\n");
              num_csv = num_csv.join("\n");

              resolve(bool_csv);
            } catch (err) {
              reject("csv 파싱 오류: " + err.message); // 오류 발생 시
            }
          };
          reader.onerror = function () {
            reject("파일 읽기 오류");
          };
          reader.readAsText(file); // 파일을 텍스트 형식으로 읽음
        });
      }
      //csv파일이 바뀔때 마다 함수를 실행
      document.getElementById("loadCsv").addEventListener("change", showCsv);

      function showTestChart(csv) {
        //CSV 파일에서 데이터 로드
        var header = csv.split("\n")[0].split(",");
        var seriesCount = header.length - 1; // 첫 번째 열 = 번호
        var visibilityArray = Array(seriesCount).fill(true);

        //숫자 차트 그리기
        var chart = new Dygraph(
          document.getElementById("graphdiv"), // 차트를 표시할 div
          csv, // CSV 파일의 데이터
          {
            title: "CSV Data Chart", //타이틀
            ylabel: "Value", //y
            showRoller: true, // 롤러 활성화
            legend: "always", // 범례 항상 표시
            visibility: visibilityArray,
          },
        );
        //범례 표시(체크박스)
        const legends = chart.getLabels().slice(1);
        const legend_div = document.getElementById("legendData");
        legend_div.replaceChildren();
        legends.forEach((legend) => {
          const label = document.createElement("label");
          label.textContent = legend;

          const input = document.createElement("input");
          input.type = "checkbox";
          input.id = legend;
          input.checked = true;
          label.appendChild(input);
          legend_div.appendChild(label);
        });
        //리셋 줌 버튼
        document
          .getElementById("resetZoomBtn")
          .addEventListener("click", function () {
            chart.resetZoom();
          });
        //휠로 줌 설정
        document
          .getElementById("graphdiv")
          .addEventListener("wheel", function (event) {
            // 기본 스크롤 동작 방지
            event.preventDefault();

            // 휠 이벤트의 deltaY 값에 따라 줌 처리
            const zoomFactor = event.deltaY > 0 ? 1.5 : 0.5; // 휠 방향에 따라 줌 인/아웃
            const range = chart.xAxisRange(); // 현재 x축 범위
            const midPoint = (range[0] + range[1]) / 2; // 중간 지점 계산

            const newMin = midPoint + (range[0] - midPoint) * zoomFactor; // 새로운 최소값 계산
            const newMax = midPoint + (range[1] - midPoint) * zoomFactor; // 새로운 최대값 계산

            if (newMin <= 0) {
              newMin = 0;
            }

            chart.updateOptions({
              dateWindow: [newMin, newMax],
            });
          });

        //체크박스를 클릭해 데이터 지우고 보이기
        document
          .getElementById("legendData")
          .addEventListener("change", function () {
            const check_inputs = Array.from(
              document.querySelectorAll('#legendData input[type="checkbox"]'),
            );
            console.log(check_inputs);
            const check_statues = check_inputs.map((input) => input.checked);

            chart.updateOptions({
              visibility: check_statues,
            });
          });
      }
    </script>
    <!-- 표 생성하기 -->
    <script>
      function ready() {
        if (typeof webui !== "undefined") {
          webui.setEventCallback((e) => {
            if (e == webui.event.CONNECTED) {
              webui.call("sendJson").then((response) => {
                const dict = JSON.parse(response);
                appendTable(dict);
              });
              webui.call("sendDygraph").then((response) => {
                var dygraph = document.createElement("script");
                dygraph.innerHTML = response;
                var target = document.getElementsByTagName("head")[0];
                target.appendChild(dygraph);
              });
            }
          });
        }
      }

      function appendTable(dict, keys = "") {
        const t_body = document.getElementById("table");
        for (let key in dict) {
          if (typeof dict[key] == "object") {
            const k = keys + "_" + key;
            const row = document.createElement("tr");
            const header = document.createElement("th");
            header.colSpan = "2";
            header.className = "section-header";
            header.textContent = key;
            row.appendChild(header);
            t_body.appendChild(row);
            appendTable(dict[key], k);
          } else {
            const row = document.createElement("tr");
            const nameCell = document.createElement("td");
            const inputCell = document.createElement("td");
            const inputField = document.createElement("input");

            nameCell.textContent = key; // 이름(키) 추가
            if (keys.includes("flags") || key == "flags") {
              inputField.type = "checkbox"; // 입력 타입 설정
            } else {
              inputField.type = "number"; // 입력 타입 설정
            }

            inputField.name = key;
            inputField.id = keys + "_" + key;
            inputField.style.width = "200px";
            inputField.style.padding = "3px";
            inputCell.appendChild(inputField); // 입력 필드 추가

            row.appendChild(nameCell);
            row.appendChild(inputCell);
            t_body.appendChild(row);
          }
        }
      }
      document.addEventListener("DOMContentLoaded", ready);
    </script>

    <div id="container">
      <table id="table"></table>
      <div id="legendData"></div>
    </div>
    <div id="graphdiv" style="width: 1200px; height: 1200px"></div>
  </body>
</html>
