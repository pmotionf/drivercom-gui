<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <script src="/webui.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
         body {
            display: flex;
            flex-direction: column; /* 세로 방향으로 배치 */
            align-items: center; /* 중앙 정렬 */
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        
        #container {
            display: flex; /* 가로 방향으로 배치 */
            justify-content: space-between; /* 양쪽 끝에 배치 */
            width: 100%; /* 전체 너비 */
            margin-top: 20px; /* 버튼과의 여백 */
        }
        
        #table {
            width: 30%; /* 표 영역의 너비 */
        }
        
        #chart {
            width: 60%; /* 그래프 영역의 너비 */
            
        }
        
        canvas {
            width: 70; /* 차트의 너비를 100%로 설정 */
            height: 100%;
        }
        
        table {
            width: 100%; /* Slightly smaller width */
            border-collapse: collapse;
            margin: auto;
        }
        
        table, th, td {
            border: 1px solid black;
        }
        
        th, td {
            padding: 6px;
            text-align: left;
        }
        
        th {
            background-color: #f2f2f2;
        }
        
        .section-header {
            font-weight: bold;
            text-align: center;
            background-color: #d9d9d9;
        }
        
        input[type="text"] {
            width: 90%;
            box-sizing: border-box;
            padding: 3px;
        }
    </style>
    <title>값 변경하기</title>
</head>
<body>
    <div class="section-header">SHDrv-server</div>
    <label for="avatar">config 파일을 선택해 주세요.</label>
    <input type="file" id="avatar" name="avatar" accept=" .yml "/>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <script>
        function openrFile() {
            var input = document.getElementById('avatar');
            var file = input.files[0]; // 선택한 파일 객체
            if (file) {
                console.log(readYAMLFile(file));
                return file.name;
            } else {
                return null;
            }
        }

        function showConfig() {
            var input = document.getElementById('avatar');
            var file = input.files[0]; // 선택한 파일 객체
            if (file) {
                const promise  = readYAMLFile(file);
                promise.then(result => {
                    const dict = result;
                    console.log("file:", dict);

                    //모든 value 저장
                    const all_value = extractValues(dict);
                    console.log(all_value);


                    //html의 모든 id 저장
                    const allElements = document.querySelectorAll('input[type="text"], input[type="number"]');
                    const ids = [];
                    allElements.forEach(element => {
                        ids.push(element.id);   
                    });
                    console.log(ids);

                    //값을 변환
                    for(let i=0; i < ids.length; i++) {
                        var v = document.getElementById(ids[i]);
                        v.value = all_value[i];
                    }
                })
                
            } 
        }

        function readYAMLFile(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                try {
                    const yamlObject = jsyaml.load(content);  // YAML을 파싱하여 JavaScript 객체로 변환
                    if (typeof yamlObject === 'object' && yamlObject !== null) {
                        resolve(yamlObject);  // 파싱된 객체를 반환
                    } else {
                         reject('YAML 파일이 유효한 딕셔너리 형식이 아닙니다.');
                    }
                } catch (err) {
                    reject('YAML 파싱 오류: ' + err.message);  // 오류 발생 시
                }
            };
            reader.onerror = function() {
                reject('파일 읽기 오류');
            };
            reader.readAsText(file);  // 파일을 텍스트 형식으로 읽음  
            });
        }

        function getValue(){
            webui.call('saveValue').then((response) => {
                const dict = JSON.parse(response);

                //html의 모든 value 저장
                const allElements = document.querySelectorAll('input[type="text"], input[type="number"]');
                const values = [];//
                allElements.forEach(element => {
                    if(element.value == ""){
                        values.push(0);
                    }else{
                        values.push(element.value);
                    }
                });
                
                let index = 0;
                extractKey(dict, values, index);
                console.log(dict);


                //vkdlf wjwkd
                const blob = new Blob([JSON.stringify(dict)], { type: 'text/yaml' });
                const url = URL.createObjectURL(blob);

                // 다운로드 링크 생성
                const a = document.createElement('a');
                a.href = url;

                // 현재 날짜와 시간을 가져오기
                const currentDate = new Date();

                // 날짜와 시간을 문자열로 포맷팅
                const formattedDate = `${currentDate.getFullYear()}-${currentDate.getMonth() + 1}-${currentDate.getDate()} ${currentDate.getHours()}:${currentDate.getMinutes()}:${currentDate.getSeconds()}`;

                // 포맷팅된 날짜와 시간을 출력
                a.download = formattedDate +'config.yml'; // 다운로드할 파일 이름

                // 링크 클릭하여 다운로드
                document.body.appendChild(a);
                a.click();

                // 링크 제거
                document.body.removeChild(a);
                URL.revokeObjectURL(url); // Blob URL 해제

            });

            
        }
        
        function extractKey(dict, values, index) {
            for(let key in dict){
                if(typeof dict[key] == 'object'){
                    extractKey(dict[key],values, index);
                }
                else{
                    dict[key] = values[index++];
                }
            }
        }
        function extractValues(dict) {
            const result = [];
            for (const key in dict){
                const value = dict[key];

                if(typeof value == "number"){
                    result.push(value);
                }
                else{
                    const in_value = extractValues(value);
                    result.push(...in_value);
                }
            }
            return result;
        }
      

    document.getElementById('avatar').addEventListener("change", showConfig );
    </script>

 


    <!-- <div class="save-button"></div> -->
    <button type="button" onclick="getValue();">save</button>
    <!-- </div> -->

    <label for="avatar">.csv 파일을 선택해 주세요.</label>
    <input type="file" id="loadCvs" name="avatar" accept=" .csv "/>

    <script>
        function showCsv(){
            var input = document.getElementById('loadCvs');
            var file = input.files[0]; // 선택한 파일 객체
            if (file) {
                const promise = readCsvFile(file);
                promise.then(result => {
                    console.log(result[0]); //
                })
            } 

        }

        function readCsvFile(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                try {
                    const csv_object = content.split('\r\n');  
                    resolve(csv_object);
            
                } catch (err) {
                    reject('csv 파싱 오류: ' + err.message);  // 오류 발생 시
                }
            };
            reader.onerror = function() {
                reject('파일 읽기 오류');
            };
            reader.readAsText(file);  // 파일을 텍스트 형식으로 읽음  
            });
        }

        document.getElementById('loadCvs').addEventListener("change", showCsv );
    </script>

    <div id="container">
    <table id = "table">
        <tr>
            <th colspan="2" class="section-header">id</th>
        </tr>
        <tr>
            <td>id</td>
            <td><input type="number" name="id" id="id"></td>
        </tr>
        <tr>
            <td>station_id</td>
            <td><input type="text" name="station_id" id="station_id"></td>
        </tr>
        <tr></tr>
            <th colspan="2" class="section-header">flags</th>
        </tr>
        <tr>
            <td>home_sensor</td>
            <td><input type="text" name="home_sensor" id="home_sensor"></td>
        </tr>
        <tr>
            <td>has_neighbor_backward</td>
            <td><input type="text" name="has_neighbor_backward" id="has_neighbor_backward"></td>
        </tr>
        <tr>
            <td>has_neighbor_forward</td>
            <td><input type="text" name="has_neighbor_forward" id="has_neighbor_forward"></td>
        </tr>
        <tr>
            <td>uses_axis2</td>
            <td><input type="text" name="uses_axis2" id="uses_axis2"></td>
        </tr>
        <tr>
            <td>uses_axis3</td>
            <td><input type="text" name="uses_axis3" id="uses_axis3"></td>
        </tr>
        <tr>
            <td>calibration_completed</td>
            <td><input type="text" name="calibration_completed" id="calibration_completed"></td>
        </tr>
        <tr>
            <td>rockwell_magnet</td>
            <td><input type="text" name="rockwell_magnet" id="rockwell_magnet"></td>
        </tr>
        <tr>
            <th colspan="2" class="section-header">magnet</th>
        </tr>
        <tr>
            <td>pitch</td>
            <td><input type="text" name="pitch" id="pitch"></td>
        </tr>
        <tr>
            <td>length</td>
            <td><input type="text" name="length" id="length"></td>
        </tr>
        <tr>
            <th colspan="2" class="section-header">Mechanical</th>
        </tr>
        <tr>
            <td>vehicle_mass</td>
            <td><input type="text" name="vehicle_mass" id="vehicle_mass"></td>
        </tr>
        <tr>
            <td>mechanical_angle_offset</td>
            <td><input type="text" name="mechanical_angle_offset" id="mechanical_angle_offset"></td>
        </tr>
        <tr>
            <td>axis_length</td>
            <td><input type="text" name="axis_length" id="axis_length"></td>
        </tr>
        <tr>
            <td>motor_length</td>
            <td><input type="text" name="motor_length" id="motor_length"></td>
        </tr>
        <tr>
            <td>calibrated_home_position</td>
            <td><input type="text" name="calibrated_home_position" id="calibrated_home_position"></td>
        </tr>
        <tr>
            <td>total_axes</td>
            <td><input type="text" name="total_axes" id="total_axes"></td>
        </tr>
        <tr></tr>
            <th colspan="2" class="section-header">Electrical</th>
        </tr>
        <tr>
            <td>warmup_voltage_reference</td>
            <td><input type="text" name="warmup_voltage_reference" id="warmup_voltage_reference"></td>
        </tr>
        <tr>
            <td>backward</td>
            <td><input type="text" name="backward" id="backward"></td>
        </tr>
        <tr>
            <td>forward</td>
            <td><input type="text" name="forward" id="forward"></td>
        </tr>
        <tr>
            <td>target</td>
            <td><input type="text" name="target" id="target"></td>
        </tr>
        <tr>
            <td>limit_lower</td>
            <td><input type="text" name="limit_lower" id="limit_lower"></td>
        </tr>
        <tr>
            <td>limit_upper</td>
            <td><input type="text" name="limit_upper" id="limit_upper"></td>
        </tr>
    
        <!-- axes1 section -->
        <tr>
            <th colspan="2" class="section-header">axes1</th>
        </tr>
        <tr>
            <td>max_current_axes1</td>
            <td><input type="text" name="max_current_axes1" id="max_current_axes1"></td>
        </tr>
        <tr>
            <td>continuous_current_axes1</td>
            <td><input type="text" name="continuous_current_axes1" id="continuous_current_axes1"></td>
        </tr>
        <tr>
            <td>current_gain_p_axes1</td>
            <td><input type="text" name="current_gain_p_axes1" id="current_gain_p_axes1"></td>
        </tr>
        <tr>
            <td>current_gain_i_axes1</td>
            <td><input type="text" name="current_gain_i_axes1" id="current_gain_i_axes1"></td>
        </tr>
        <tr>
            <td>current_gain_denominator_axes1</td>
            <td><input type="text" name="current_gain_i_axes1" id="current_gain_current_gain_denominator_axes1_axes1"></td>
        </tr>
        <tr>
            <td>velocity_gain_p_axes1</td>
            <td><input type="text" name="velocity_gain_p_axes1" id="velocity_gain_p_axes1"></td>
        </tr>
        <tr>
            <td>velocity_gain_i_axes1</td>
            <td><input type="text" name="velocity_gain_i_axes1" id="velocity_gain_i_axes1"></td>
        </tr>
        <tr>
            <td>velocity_gain_denominator_axes1</td>
            <td><input type="text" name="velocity_gain_denominator_axes1" id="velocity_gain_denominator_axes1"></td>
        </tr>
        <tr>
            <td>velocity_gain_denominator_pi_axes1</td>
            <td><input type="text" name="velocity_gain_denominator_pi_axes1" id="velocity_gain_denominator_pi_axes1"></td>
        </tr>
        <tr>
            <td>position_gain_p_axes1</td>
            <td><input type="text" name="position_gain_p_axes1" id="position_gain_p_axes1"></td>
        </tr>
        <tr>
            <td>position_gain_denominator_axes1</td>
            <td><input type="text" name="position_gain_denominator_axes1" id="position_gain_denominator_axes1"></td>
        </tr>
        <tr>
            <td>in_position_threshold_axes1</td>
            <td><input type="text" name="in_position_threshold_axes1" id="in_position_threshold_axes1"></td>
        </tr>
        <tr>
            <td>base_position_axes1</td>
            <td><input type="text" name="base_position_axes1" id="base_position_axes1"></td>
        </tr>
        <tr>
            <td>back_sensor_off_position_axes1</td>
            <td><input type="text" name="back_sensor_off_position_axes1" id="back_sensor_off_position_axes1"></td>
        </tr>
        <tr>
            <td>back_sensor_off_section_count_axes1</td>
            <td><input type="text" name="back_sensor_off_section_count_axes1" id="back_sensor_off_section_count_axes1"></td>
        </tr>
        <tr>
            <td>front_sensor_off_position_axes1</td>
            <td><input type="text" name="front_sensor_off_position_axes1" id="front_sensor_off_position_axes1"></td>
        </tr>
        <tr>
            <td>front_sensor_off_section_count_axes1</td>
            <td><input type="text" name="front_sensor_off_section_count_axes1" id="front_sensor_off_section_count_axes1"></td>
        </tr>
        <tr>
            <td>rs_axes1</td>
            <td><input type="text" name="rs_axes1" id="rs_axes1"></td>
        </tr>
        <tr>
            <td>ls_axes1</td>
            <td><input type="text" name="ls_axes1" id="ls_axes1"></td>
        </tr>
        <tr>
            <td>kf_axes1</td>
            <td><input type="text" name="kf_axes1" id="kf_axes1"></td>
        </tr>
        <tr>
            <td>kbm_axes1</td>
            <td><input type="text" name="kbm_axes1" id="kbm_axes1"></td>
        </tr>
    
        <!-- axes2 section -->
        <tr>
            <th colspan="2" class="section-header">axes2</th>
        </tr>
        <tr>
            <td>max_current_axes2</td>
            <td><input type="text" name="max_current_axes2" id="max_current_axes2"></td>
        </tr>
        <tr>
            <td>continuous_current_axes2</td>
            <td><input type="text" name="continuous_current_axes2" id="continuous_current_axes2"></td>
        </tr>
        <tr>
            <td>current_gain_p_axes2</td>
            <td><input type="text" name="current_gain_p_axes2" id="current_gain_p_axes2"></td>
        </tr>
        <tr>
            <td>current_gain_i_axes2</td>
            <td><input type="text" name="current_gain_i_axes2" id="current_gain_i_axes2"></td>
        </tr>
        <tr></tr>
            <td>current_gain_denominator_axes2</td>
            <td><input type="text" name="current_gain_i_axes2" id="current_gain_current_gain_denominator_axes2"></td>
        </tr>
        <tr>
            <td>velocity_gain_p_axes2</td>
            <td><input type="text" name="velocity_gain_p_axes2" id="velocity_gain_p_axes2"></td>
        </tr>
        <tr>
            <td>velocity_gain_i_axes2</td>
            <td><input type="text" name="velocity_gain_i_axes2" id="velocity_gain_i_axes2"></td>
        </tr>
        <tr>
            <td>velocity_gain_denominator_axes2</td>
            <td><input type="text" name="velocity_gain_denominator_axes2" id="velocity_gain_denominator_axes2"></td>
        </tr>
        <tr>
            <td>velocity_gain_denominator_pi_axes2</td>
            <td><input type="text" name="velocity_gain_denominator_pi_axes2" id="velocity_gain_denominator_pi_axes2"></td>
        </tr>
        <tr>
            <td>position_gain_p_axes2</td>
            <td><input type="text" name="position_gain_p_axes2" id="position_gain_p_axes2"></td>
        </tr>
        <tr>
            <td>position_gain_denominator_axes2</td>
            <td><input type="text" name="position_gain_denominator_axes2" id="position_gain_denominator_axes2"></td>
        </tr>
        <tr>
            <td>in_position_threshold_axes2</td>
            <td><input type="text" name="in_position_threshold_axes2" id="in_position_threshold_axes2"></td>
        </tr>
        <tr>
            <td>base_position_axes2</td>
            <td><input type="text" name="base_position_axes2" id="base_position_axes2"></td>
        </tr>
        <tr>
            <td>back_sensor_off_position_axes2</td>
            <td><input type="text" name="back_sensor_off_position_axes2" id="back_sensor_off_position_axes2"></td>
        </tr>
        <tr>
            <td>back_sensor_off_section_count_axes2</td>
            <td><input type="text" name="back_sensor_off_section_count_axes2" id="back_sensor_off_section_count_axes2"></td>
        </tr>
        <tr>
            <td>front_sensor_off_position_axes2</td>
            <td><input type="text" name="front_sensor_off_position_axes2" id="front_sensor_off_position_axes2"></td>
        </tr>
        <tr>
            <td>front_sensor_off_section_count_axes2</td>
            <td><input type="text" name="front_sensor_off_section_count_axes2" id="front_sensor_off_section_count_axes2"></td>
        </tr>
        <tr>
            <td>rs_axes2</td>
            <td><input type="text" name="rs_axes2" id="rs_axes2"></td>
        </tr>
        <tr>
            <td>ls_axes2</td>
            <td><input type="text" name="ls_axes2" id="ls_axes2"></td>
        </tr>
        <tr>
            <td>kf_axes2</td>
            <td><input type="text" name="kf_axes2" id="kf_axes2"></td>
        </tr>
        <tr>
            <td>kbm_axes2</td>
            <td><input type="text" name="kbm_axes2" id="kbm_axes2"></td>
        </tr>
    
        <!-- axes3 section -->
        <tr>
            <th colspan="2" class="section-header">axes3</th>
        </tr>
        <tr>
            <td>max_current_axes3</td>
            <td><input type="text" name="max_current_axes3" id="max_current_axes3"></td>
        </tr>
        <tr>
            <td>continuous_current_axes3</td>
            <td><input type="text" name="continuous_current_axes3" id="continuous_current_axes3"></td>
        </tr>
        <tr>
            <td>current_gain_p_axes3</td>
            <td><input type="text" name="current_gain_p_axes3" id="current_gain_p_axes3"></td>
        </tr>
        <tr>
            <td>current_gain_i_axes3</td>
            <td><input type="text" name="current_gain_i_axes3" id="current_gain_i_axes3"></td>
        </tr>
        <tr></tr>
            <td>current_gain_denominator_axes1</td>
            <td><input type="text" name="current_gain_i_axes3" id="current_gain_current_gain_denominator_axes1_axes3"></td>
        </tr>
        <tr>
            <td>velocity_gain_p_axes3</td>
            <td><input type="text" name="velocity_gain_p_axes3" id="velocity_gain_p_axes3"></td>
        </tr>
        <tr>
            <td>velocity_gain_i_axes3</td>
            <td><input type="text" name="velocity_gain_i_axes3" id="velocity_gain_i_axes3"></td>
        </tr>
        <tr>
            <td>velocity_gain_denominator_axes3</td>
            <td><input type="text" name="velocity_gain_denominator_axes3" id="velocity_gain_denominator_axes3"></td>
        </tr>
        <tr>
            <td>velocity_gain_denominator_pi_axes3</td>
            <td><input type="text" name="velocity_gain_denominator_pi_axes3" id="velocity_gain_denominator_pi_axes3"></td>
        </tr>
        <tr>
            <td>position_gain_p_axes3</td>
            <td><input type="text" name="position_gain_p_axes3" id="position_gain_p_axes3"></td>
        </tr>
        <tr>
            <td>position_gain_denominator_axes3</td>
            <td><input type="text" name="position_gain_denominator_axes3" id="position_gain_denominator_axes3"></td>
        </tr>
        <tr>
            <td>in_position_threshold_axes3</td>
            <td><input type="text" name="in_position_threshold_axes3" id="in_position_threshold_axes3"></td>
        </tr>
        <tr>
            <td>base_position_axes3</td>
            <td><input type="text" name="base_position_axes3" id="base_position_axes3"></td>
        </tr>
        <tr>
            <td>back_sensor_off_position_axes3</td>
            <td><input type="text" name="back_sensor_off_position_axes3" id="back_sensor_off_position_axes3"></td>
        </tr>
        <tr>
            <td>back_sensor_off_section_count_axes3</td>
            <td><input type="text" name="back_sensor_off_section_count_axes3" id="back_sensor_off_section_count_axes3"></td>
        </tr>
        <tr>
            <td>front_sensor_off_position_axes3</td>
            <td><input type="text" name="front_sensor_off_position_axes3" id="front_sensor_off_position_axes3"></td>
        </tr>
        <tr>
            <td>front_sensor_off_section_count_axes3</td>
            <td><input type="text" name="front_sensor_off_section_count_axes3" id="front_sensor_off_section_count_axes3"></td>
        </tr>
        <tr>
            <td>rs_axes3</td>
            <td><input type="text" name="rs_axes3" id="rs_axes3"></td>
        </tr>
        <tr>
            <td>ls_axes3</td>
            <td><input type="text" name="ls_axes3" id="ls_axes3"></td>
        </tr>
        <tr>
            <td>kf_axes3</td>
            <td><input type="text" name="kf_axes3" id="kf_axes3"></td>
        </tr>
        <tr>
            <td>kbm_axes3</td>
            <td><input type="text" name="kbm_axes3" id="kbm_axes3"></td>
        </tr>
        <tr>
            <th colspan="2" class="section-header">hall_sensors</th>
        </tr>
        <tr>
            <td>calibrated_magnet_length_backward</td>
            <td><input type="text" name="calibrated_magnet_length_backward" id = "hall_back_1"></td>
        </tr>
        <tr>
            <td>calibrated_magnet_length_forward</td>
            <td><input type="text" name="calibrated_magnet_length_forward" id = "hall_for_1"></td>
        </tr>
        <tr>
            <td>calibrated_magnet_length_backward</td>
            <td><input type="text" name="calibrated_magnet_length_backward" id = "hall_back_2"></td>
        </tr>
        <tr>
            <td>calibrated_magnet_length_forward</td>
            <td><input type="text" name="calibrated_magnet_length_forward" id = "hall_for_2"></td>
        </tr>
        <tr>
            <td>calibrated_magnet_length_backward</td>
            <td><input type="text" name="calibrated_magnet_length_backward" id = "hall_back_3"></td>
        </tr>
        <tr>
            <td>calibrated_magnet_length_forward</td>
            <td><input type="text" name="calibrated_magnet_length_forward" id = "hall_for_3"></td>
        </tr>
        <tr>
            <td>calibrated_magnet_length_backward</td>
            <td><input type="text" name="calibrated_magnet_length_backward" id = "hall_back_4"></td>
        </tr>
        <tr>
            <td>calibrated_magnet_length_forward</td>
            <td><input type="text" name="calibrated_magnet_length_forward" id = "hall_for_4"></td>
        </tr>
        <tr>
            <td>calibrated_magnet_length_backward</td>
            <td><input type="text" name="calibrated_magnet_length_backward" id = "hall_back_5"></td>
        </tr>
        <tr>
            <td>calibrated_magnet_length_forward</td>
            <td><input type="text" name="calibrated_magnet_length_forward" id = "hall_for_5"></td>
        </tr>
        <tr>
            <td>calibrated_magnet_length_backward</td>
            <td><input type="text" name="calibrated_magnet_length_backward" id = "hall_back_6"></td>
        </tr>
        <tr>
            <td>calibrated_magnet_length_forward</td>
            <td><input type="text" name="calibrated_magnet_length_forward" id = "hall_for_6"></td>
        </tr>
    </table>
    <div id="chart"></div>
        <canvas id="myChart" width="400" height="300"></canvas>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    
    <script>
        var ctx = document.getElementById('myChart').getContext('2d');
        var chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['값1', '값2', '값3'],
                datasets: [{
                    label: '차트1',
                    data: [10, 20, 30],
                    borderColor:'rgba(255, 99, 132, 1)',
                      
                    borderWidth: 1
                },
                {
                    label: '차트2',
                    data: [118.02,112.03,115.05],
                    borderColor:'rgba(255, 99, 132, 1)',
                      
                    borderWidth: 1
                }]
            },
            
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    </script>
</body>
</html>
